# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
name: Release / Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to build artifacts for"
        required: true

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  artifact:
    # strategy:
    #   fail-fast: false # Don't cancel other jobs if one fails
    #   matrix:
    #     python-version: ["3.12", "3.13"]
    runs-on: ubuntu-latest
    name: Artifact

    outputs:
      hash: ${{ steps.hash.outputs.hash }}
      artifact-name: ${{ steps.hash.outputs.artifact-name }}
      tag-name: ${{ steps.hash.outputs.tag-name }}
      digest: ${{ steps.build-push.outputs.digest }}

    steps:
    - name: üîß Set TAG_NAME variable
      id: tag
      run: |
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
        fi

    - name: üöö Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0

    - name: üéâ Set up Python
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
      with:
        python-version: "3.14"

    - name: üéâ Setup Uv
      uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7.1.3
      with:
        #   python-version: ${{ matrix.python-version }}
        working-directory: ./

    - name: ‚úÖ Build application
      run: |
        uv build

    - name: ‚úÖ Prepare Artifacts
      id: hash
      run: |
        set -euo pipefail

        artifact_name=llm_observability_lab-$TAG_NAME.tar.gz
        echo "artifact-name=$artifact_name" >> "$GITHUB_OUTPUT"

        checksum=$(sha256sum $artifact_name | base64 -w0)
        echo "hash=$checksum" >> "$GITHUB_OUTPUT"

        echo "tag-name=$TAG_NAME" >> "${GITHUB_OUTPUT}"

    - name: üîì Attest Artifacts Provenance
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
      with:
        subject-path: "${{ steps.hash.outputs.artifact-name }}"

    - name: ‚úÖ Generate SBOM
      uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0.20.9
      id: sbom
      with:
        path: ${{ github.workspace }}
        format: spdx-json
        output-file: ${{ steps.hash.outputs.artifact-name }}.spdx.json
        upload-artifact: false

    - name: üîì Attest SBOM
      uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
      with:
        subject-path: "${{ steps.hash.outputs.artifact-name }}"
        sbom-path: "${{ steps.hash.outputs.artifact-name }}.spdx.json"

    - name: ‚¨ÜÔ∏è Upload SBOM
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: ${{ steps.hash.outputs.artifact-name }}-sbom
        path: ${{ steps.hash.outputs.artifact-name }}.spdx.json
        retention-days: 90

    - name: ‚¨ÜÔ∏è Upload artifacts
      uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2.4.2
      with:
        tag_name: ${{ env.TAG_NAME }}
        files: |
          ${{ steps.hash.outputs.artifact-name }}
          ${{ steps.hash.outputs.artifact-name }}.spdx.json

  docker:
    runs-on: ubuntu-latest
    # needs:
    # - artifact
    name: Docker

    steps:
    - name: üîß Set TAG_NAME variable
      id: tag
      run: |
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
        fi

    - name: üöö Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

    - name: üê≥ Log in to GitHub Container Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üê≥ Extract metadata
      id: meta
      uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha

    - name: üê≥ Build and push Docker image
      id: build-push
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        context: ./
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        sbom: true
        provenance: mode=max
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: üéâ Install cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

    - name: üîì Sign images
      shell: bash
      env:
        COSIGN_YES: "true"
        DIGEST: ${{ steps.build-push.outputs.digest }}
      run: |
        cosign sign \
          --recursive \
          --oidc-provider=github-actions \
          ghcr.io/${{ github.repository }}@${DIGEST}

  artifact-provenance:
    needs:
    - artifact

    # strategy:
    #   fail-fast: false # Don't cancel other jobs if one fails
    #   matrix:
    #     python-version: ["3.12", "3.13"]

    permissions:
      actions: read # To read the workflow path.
      contents: write # To add assets to a release.
      id-token: write # To sign the provenance.
      packages: write # Required for publishing provenance.

    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.artifact.outputs.hash }}"
      provenance-name: provenance.intoto.jsonl
      upload-assets: true
      upload-tag-name: ${{ needs.artifact.outputs.tag-name }}

  image-provenance:
    needs:
    - docker
    permissions:
      actions: read # To read the workflow path.
      contents: write # To add assets to a release.
      id-token: write # To sign the provenance.
      packages: write # Required for publishing provenance.

    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      digest: "${{ needs.docker.outputs.digest }}"
      image: "llm-observability-lab"
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  verification:
    needs:
    - artifact-provenance
    - image-provenance

    runs-on: ubuntu-latest

    steps:
    - name: üõ°Ô∏è Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
      with:
        egress-policy: audit

    - name: üéâ Install the SLSA verifier
      uses: slsa-framework/slsa-verifier/actions/installer@ea584f4502babc6f60d9bc799dbbb13c1caa9ee6 # v2.7.1

    - name: ‚¨áÔ∏è Download assets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail

        echo "Download artifacts from ${{ github.repository }} for ${{ needs.release.outputs.tag-name }}"
        gh -R "${{ github.repository }}" release download "${{ needs.release.outputs.tag-name }}" -p "opamui-${{ needs.release.outputs.tag-name }}-*"
        gh -R "${{ github.repository }}" release download "${{ needs.release.outputs.tag-name }}" -p "*-provenance.intoto.jsonl"
        ls -al

    - name: ‚úÖ Verify artifact
      run: |
        set -euo pipefail

        for artifact in $(ls opamui-${{ needs.release.outputs.tag-name }}-*); do

          if [[ "$artifact" == *"latest"* ]] || [[ "$artifact" == *"spdx"* ]]; then
            continue
          fi

          if [[ "$artifact" == *"linux"* ]]; then
            provenance="ubuntu-latest-provenance.intoto.jsonl"
          elif [[ "$artifact" == *"macos"* ]]; then
            provenance="macos-latest-provenance.intoto.jsonl"
          else
            echo "Erreur : Invalid artifact: $artifact"
            exit 1
          fi

          slsa-verifier verify-artifact $artifact \
            --provenance-path $provenance \
            --source-uri github.com/${{ github.repository }} \
            --source-tag "${{ needs.release.outputs.tag-name }}"
        done
